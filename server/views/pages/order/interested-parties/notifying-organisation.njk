{% extends "../../../partials/form-layout.njk" %}

{% from "govuk/components/input/macro.njk" import govukInput %}
{% from "govuk/components/radios/macro.njk" import govukRadios %}
{% from "../../../components/accessible-autocomplete/macro.njk" import accessibleAutocomplete %}

{% set section = content.pages.notifyingOrganisation.section %}
{% set heading = content.pages.notifyingOrganisation.title %}
{% set legend = content.pages.notifyingOrganisation.legend %}
{% set helpText = content.pages.notifyingOrganisation.helpText %}
{% set questions = content.pages.notifyingOrganisation.questions %}
{% set singleQuestionPage = true %}

{% set visuallyHiddenHint %}
  <span class="govuk-visually-hidden"> Selecting this will reveal an additional input</span>
{% endset %}

{% set crownCourtHtml %}
  {{ accessibleAutocomplete({
    id: 'crownCourt',
    name: 'crownCourt',
    label: questions.crownCourt.text,
    options: content.reference.crownCourts | toOptions(false, true),
    value: notifyingOrganisationName.value,
    errorMessage: notifyingOrganisationName.error,
    nonce: cspNonce
  }) }}
{% endset %}

{% set magistratesCourtHtml %}
  {{ accessibleAutocomplete({
    id: 'magistratesCourt',
    name: 'magistratesCourt',
    label: questions.magistratesCourt.text,
    options: content.reference.magistratesCourts | toOptions(false, true),
    value: notifyingOrganisationName.value,
    errorMessage: notifyingOrganisationName.error,
    nonce: cspNonce
  }) }}
{% endset %}

{% set prisonHtml %}
  {{ accessibleAutocomplete({
    id: 'prison',
    name: 'prison',
    label: questions.prison.text,
    hint: questions.prison.hint,
    options: content.reference.prisons | toOptions(false, true) | removeOptions(['COOKHAM_WOOD_YOUNG_OFFENDER_INSTITUTION']),
    value: notifyingOrganisationName.value,
    errorMessage: notifyingOrganisationName.error,
    nonce: cspNonce
  }) }}
{% endset %}

{% if DDv5 %}
  {% set civilCountyCourtHtml %}
    {{ accessibleAutocomplete({
      id: 'civilCountyCourt',
      name: 'civilCountyCourt',
      label: questions.civilCountyCourt.text,
      options: content.reference.civilCountyCourts | toOptions(false, true),
      value: notifyingOrganisationName.value,
      errorMessage: notifyingOrganisationName.error,
      nonce: cspNonce
    }) }}
  {% endset %}

    {% set familyCourtHtml %}
    {{ accessibleAutocomplete({
      id: "familyCourt",
      name: "familyCourt",
      label: questions.familyCourt.text,
      options: content.reference.familyCourts | toOptions(false, true),
      value: notifyingOrganisationName.value,
      errorMessage: notifyingOrganisationName.error,
      nonce: cspNonce
    }) }}
  {% endset %}

  {% set militaryCourtHtml %}
    {{ accessibleAutocomplete({
      id: "militaryCourt",
      name: "militaryCourt",
      label: questions.militaryCourt.text,
      options: content.reference.militaryCourts | toOptions(false, true),
      value: notifyingOrganisationName.value,
      errorMessage: notifyingOrganisationName.error,
      nonce: cspNonce
    }) }}
  {% endset %}

  {% set youthCourtHtml %}
    {{ accessibleAutocomplete({
      id: 'youthCourt',
      name: 'youthCourt',
      label: questions.youthCourt.text,
      options: content.reference.youthCourts | toOptions(false, true),
      value: notifyingOrganisationName.value,
      errorMessage: notifyingOrganisationName.error,
      nonce: cspNonce
    }) }}
  {% endset %}

   {% set youthCustodyServiceRegionHtml %}
    {{ accessibleAutocomplete({
      id: 'youthCustodyServiceRegion',
      name: 'youthCustodyServiceRegion',
      label: questions.youthCustodyServiceRegion.text,
      options: content.reference.youthCustodyServiceRegions | toOptions(false, true),
      value: notifyingOrganisationName.value,
      errorMessage: notifyingOrganisationName.error,
      nonce: cspNonce
    }) }}
  {% endset %}
{% endif %}

{% set notifyingOrgOptions = [] %}
{% for org in content.reference.notifyingOrganisations | toOptions(not isOrderEditable) %}
  {% if org.value == 'CIVIL_COUNTY_COURT' %}
    {% set notifyingOrgOptions = (notifyingOrgOptions.push({
      value: org.value,
      text: org.text,
      conditional: {
        html: civilCountyCourtHtml
      },
      disabled: org.disabled
    }), notifyingOrgOptions) %}

  {% elif org.value == 'CROWN_COURT' %}
    {% set notifyingOrgOptions = (notifyingOrgOptions.push({
      value: org.value,
      text: org.text,
      hint: {
        html: visuallyHiddenHint
      },
      conditional: {
        html: crownCourtHtml
      },
      disabled: org.disabled
    }), notifyingOrgOptions) %}

  {% elif org.value == 'FAMILY_COURT' %}
    {% set notifyingOrgOptions = (notifyingOrgOptions.push({
      value: org.value,
      text: org.text,
      conditional: {
        html: familyCourtHtml
      },
      disabled: org.disabled
    }), notifyingOrgOptions) %}

  {% elif org.value == 'MAGISTRATES_COURT' %}
    {% set notifyingOrgOptions = (notifyingOrgOptions.push({
      value: org.value,
      text: org.text,
      hint: {
        html: visuallyHiddenHint
      },
      conditional: {
        html: magistratesCourtHtml
      },
      disabled: org.disabled
    }), notifyingOrgOptions) %}

  {% elif DDv5 and org.value == 'MILITARY_COURT' %}
    {% set notifyingOrgOptions = (notifyingOrgOptions.push({
      value: org.value,
      text: org.text,
      conditional: {
        html: militaryCourtHtml
      },
      disabled: org.disabled
    }), notifyingOrgOptions) %}

  {% elif org.value == 'PRISON' %}
    {% set notifyingOrgOptions = (notifyingOrgOptions.push({
      value: org.value,
      text: org.text,
      hint: {
        html: visuallyHiddenHint
      },
      conditional: {
        html: prisonHtml
      },
      disabled: org.disabled
    }), notifyingOrgOptions) %}

  {% elif DDv5 and org.value == 'PROBATION' %}
    {% set notifyingOrgOptions = (notifyingOrgOptions.push({
      value: org.value,
      text: org.text,
      disabled: org.disabled
    }), notifyingOrgOptions) %}

  {% elif DDv5 and org.value == 'YOUTH_COURT' %}
    {% set notifyingOrgOptions = (notifyingOrgOptions.push({
      value: org.value,
      text: org.text,
      conditional: {
        html: youthCourtHtml
      },
      disabled: org.disabled
    }), notifyingOrgOptions) %}

  {% elif DDv5 and org.value == 'YOUTH_CUSTODY_SERVICE' %}
    {% set notifyingOrgOptions = (notifyingOrgOptions.push({
      value: org.value,
      text: org.text,
      conditional: {
        html: youthCustodyServiceRegionHtml
      },
      disabled: org.disabled
    }), notifyingOrgOptions) %}

  {% else %}
    {% set notifyingOrgOptions = (notifyingOrgOptions.push(org), notifyingOrgOptions) %}
  {% endif %}
{% endfor %}

{% block formInputs %}

    {{ govukRadios({
      name: "notifyingOrganisation",
      fieldset: {
        legend: {
          text: questions.notifyingOrganisation.text,
          isPageHeading: false,
          classes: "govuk-fieldset__legend--s"
        }
      },
      items: notifyingOrgOptions,
      value: notifyingOrganisation.value,
      errorMessage: notifyingOrganisation.error,
      disabled: not isOrderEditable
    }) }}

    {{ govukInput({
      label: {
        text: questions.notifyingOrganisationEmail.text,
        classes: "govuk-label--s"
      },
      hint: {
        html: questions.notifyingOrganisationEmail.hint
      },
      classes: "govuk-!-width-one-half",
      id: "notifyingOrganisationEmail",
      name: "notifyingOrganisationEmail",
      value: notifyingOrganisationEmail.value,
      errorMessage: notifyingOrganisationEmail.error,
      disabled: not isOrderEditable
    }) }}

{% endblock %}
